/**
 * 
 * 
MemberMouse(TM) (http://www.membermouse.com)
(c) 2010-2011 Pop Fizz Studios, LLC. All rights reserved.
 */
class MM_OrderHistoryView extends MM_View
{
 	public function performAction($post) 
	{	
		$response = parent::performAction($post);
		
		if(!($response instanceof MM_Response))
		{
			//$MM_JSACTION_REFUND_ORDER
			switch($post[self::$MM_JSACTION]) 
			{
				case self::$MM_JSACTION_SHOW_REFUND_OPTIONS:
					return $this->showRefundOptions($post);
					
				case self::$MM_JSACTION_REFUND_ORDER:
					return $this->refundOrder($post);
				
				default:
					return new MM_Response($response);
			}
		}
		else 
		{
			return $response;
		}
	}
	
	public function showRefundOptions($post){
		$info=new stdClass();
		$msg = MM_TEMPLATE::generate(MM_MODULES."/details_order_history.dialog.php", $info);
 		return new MM_Response($msg);
	}
	
	public function refundOrder($post){
		if(isset($post["order_id"]) && isset($post["user_id"]) && isset($post["amount"]) && isset($post["product_id"]) && isset($post["should_cancel"])){
			$user = new MM_User($post["user_id"]);
			$paymentId = MM_PaymentService::getDefaultPaymentMethodId($user);
			if(!($paymentId instanceof MM_Response)){
				$paymentEngine = new MM_PaymentEngine($paymentId);
				$order = $paymentEngine->refundOrder($post["order_id"],$post["amount"]);
				LogMe::write("refundOrder: ".json_encode($order));
				
				if($post["should_cancel"]=="1"){
					$md = new MM_MemberDetailsView();
					
					$product = new MM_Product($post["product_id"]);
					$at = $product->getAssociatedAccessTag();
					if(isset($at->id) && $at->id>0){
						$params = array(
							'mm_id'=>$post["user_id"],
							'mm_access_tag_id'=>$at->id,
						);
						return $md->deactivateAccessTag($params);
					}
					
					$mt = $product->getAssociatedMemberType();
					if(isset($mt->id) && $mt->id>0){
					
						$params = array(
							'mm_id'=>$post["user_id"],
							'mm_order_id'=>$post["order_id"]
						);
						return $md->cancelMembership($params);
					}
					else{
						return new MM_Response("Could not find valid Access Tag or Member Type to cancel", MM_Response::$ERROR);
					}
				}
				return new MM_Response("Refund Successful");	
			}
			else{
				return new MM_Response("Unable to find payment gateway to refund", MM_Response::$ERROR);
			}
		}
		else{
			return new MM_Response("Unable to find both user and order parameters", MM_Response::$ERROR);
		}
	}
 	
 	public function getData($userId,$dg=null,$startDate=null)
	{
		if(MM_Utils::isLimeLightInstall()){
			$items =  array();
			$user = new MM_User($userId);
			$dateStart = $user->getRegistrationDate();
			if(!is_null($startDate)){
				$newdate = strtotime($startDate); 
			}
			else{
				$newdate = strtotime($dateStart);
			}
			 
//			$result = MM_LimeLightService::_findOrder("all", $user->getCustomerId(), Date("m/d/Y",$newdate),  Date("m/d/Y"), Date("h:i:s"), Date("h:i:s"));
			$result = MM_LimeLightService::_findOrder("all", $user->getCustomerId(), Date("m/d/Y",$newdate),  Date("m/d/Y"), "00:00:00", "23:59:00");
			LogMe::write("OrderHistoryView::result ".json_encode($result));
			if($result instanceof MM_Response){
				
				return array();
			}
			if(isset($result["order_ids"])){
 				$orders = explode(",", $result["order_ids"]);
 				rsort($orders,SORT_NUMERIC);
 				
 				$records=  count($orders);
 				if(is_null($dg)){
 					$dg = new MM_DataGrid();
 					$dg->resultSize = (count($orders)>0)?count($orders):5;
 					$dg->crntPage= 0;
 				}
 				
 				$start = ($dg->crntPage*$dg->resultSize);
 				if($start<0) $start=0;
 				$end = ($dg->crntPage*$dg->resultSize)+$dg->resultSize;
 				if($end>$records) $end=$records;
 				
 				$cachedOrders = array();
 				for($i=$start; $i<$end; $i++){
 					$orderId = $orders[$i];
	            	$order = MM_LimeLightService::getOrder($orderId);
					if(!($order instanceof MM_Response)){
						//product_id, user_id, id,
						$itemObj = new stdClass();
						$itemObj->id = $orderId;
						$itemObj->order_date = Date("m/d/Y h:i a", strtotime($order["time_stamp"]));
						$itemObj->time_stamp = $itemObj->order_date;
						
						$itemObj->product_id = $order["main_product_id"];
						$itemObj->user_id = $userId; 
						$itemObj->order = $order;
						
						$product = new MM_Product();
						$product->getDataByProductId($order["main_product_id"], "product_id", $order["campaign_id"]);
						$itemObj->product_price = $product->getPrice(true);
						$itemObj->product_name = $product->getName();
						
						$refundable = false;
						if($order["is_recurring"]=="1"){
							if(intval($order["ancestor_id"])<=0) {
								$refundable = true;
							}
						}
						else{
							$refundable = true;
						}
						$itemObj->is_refundable = $refundable;
						$itemObj->total = count($orders);
						$items[] = $itemObj;
					}
 				}
 			}
 			return $items;
		}
		return parent::getData(MM_TABLE_ORDER_HISTORY, null, null, " user_id='{$userId}' ");
	}
	
}
