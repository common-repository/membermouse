/**
 * 
 * 
MemberMouse(TM) (http://www.membermouse.com)
(c) 2010-2011 Pop Fizz Studios, LLC. All rights reserved.
 */
class MM_TransactionEngine
{	
	public static $MM_DFLT_CUSTOMER_ID = 0;
	public static $MM_DFLT_ORDER_ID = 0;
	
	public static function placeNewOrder($post, $userId=0)
	{
		global $mmSite;
		
		$customer = new MM_User();
		if(intval($userId)>0){
			$customer = new MM_User($userId);
			if(!$customer->isValid()){
				return new MM_Response("Invalid user, cannot purchase product.", MM_Response::$ERROR);
			}
		}
	 	$customer->setEmail($post["mm_order_email"]);
		$customer->getDataByPendingEmail();
		
		// process customer information
	 	$customer->setMemberTypeId($post["mm_order_member_type"]);
	 	$customer->setUsername($post["mm_order_username"]);
	 	if(!$customer->isValid() || ($customer->isValid() && !empty($post["mm_order_password"]))){
	 		$customer->setPassword($post["mm_order_password"]);
	 	}
	 	$customer->setFirstName($post["mm_order_first_name"]);
	 	$customer->setLastName($post["mm_order_last_name"]);
	 	LogMe::write("TransactionEngine::placeNewOrder ".json_encode($post));
	 	if(isset($post['mm_order_billing_country'])){
		 	$customer->setBillingAddress($post["mm_order_billing_address"]);
		 	$customer->setBillingCity($post["mm_order_billing_city"]);
		 	$customer->setBillingState(strtoupper($post["mm_order_billing_state"]));
		 	$customer->setBillingZipCode($post["mm_order_billing_zip"]);
		 	$customer->setBillingCountry($post["mm_order_billing_country"]);
	 	}
	 	
	 	if(isset($post["mm_order_cc_number"]) && strlen($post["mm_order_cc_number"])>=4){
	 		$customer->setLastFour(substr($post["mm_order_cc_number"],-4));
	 	}
	 	
	 	if(isset($post['mm_order_shipping_country'])){
		 	$customer->setShippingAddress($post["mm_order_shipping_address"]);
		 	$customer->setShippingCity($post["mm_order_shipping_city"]);
		 	$customer->setShippingState(strtoupper($post["mm_order_shipping_state"]));
		 	$customer->setShippingZipCode($post["mm_order_shipping_zip"]);
		 	$customer->setShippingCountry($post["mm_order_shipping_country"]);
	 	}
	 	
	 	$customer->setPhone($post["mm_order_phone"]);
		$customer->setIpAddress(MM_Utils::getClientIPAddress());
		
		$shouldValidate = true;
		if($customer->isValid()){
			$shouldValidate = false;
		}
		/*
		 * Check if customer is in "Pending" state.
		 * If so, they have tried registration once before and we simply want to use the same orphaned account
		 * Otherwise, check to see if the login/email exists and validate thereafter.
		 */
		$memberExists = new MM_Response();
		if($shouldValidate){
			// check if member already exists
			$memberExists = $customer->memberExists();
		}
		
		
		if($memberExists->type == MM_Response::$SUCCESS)
		{
		
		
			$memberType = new MM_MemberType($customer->getMemberTypeId());
			
		
			// check if membership is free or paid
			if($memberType->isValid()) {
		LogMe::write("TransactionEngine::placeNewOrder : LINE: ".__LINE__." : POST: ".json_encode($post));
				
				if(((isset($post["mm_onsite_billing"]) && $post["mm_onsite_billing"] == "1" || !isset($post["mm_onsite_billing"]))) && (!$memberType->isFree() || (isset($post["mm_order_product_id"]) && intval($post["mm_order_product_id"])>0))) 
				{
		
					$order = new MM_Order();
					$product = new MM_Product($memberType->getRegistrationProduct());
					
		
					$isMemberTypeOrder = false;
					if(isset($post["mm_order_product_id"]) && intval($post["mm_order_product_id"])>0){
						if(!isset($post["mm_order_no_association"]) && !isset($post["mm_order_access_tag_id"])){
							$isMemberTypeOrder = true;
						}
						$order->setProductId($post["mm_order_product_id"]);
						$product = new MM_Product($post["mm_order_product_id"]);
					}
					else{
						$order->setProductId($memberType->getRegistrationProduct());
					}
					$campaignId =  $product->getCampaignId();
					
					// process order information
					$order->setCustomer($customer);
					$order->setCampaignId($campaignId);
					$order->setPaymentMethod($post["mm_order_payment_method"]);
					$order->setCCNumber($post["mm_order_cc_number"]);
					$order->setExpMonth($post["mm_order_cc_exp_month"]);
					$order->setExpYear($post["mm_order_cc_exp_year"]);
					$order->setSecurityCode($post["mm_order_cc_security_code"]);
					$order->setShippingMethod($post["mm_order_shipping_method"]);
					$order->setBillingSameAsShipping($post["mm_order_shipping_same_as_billing"]);
					
					$affiliateId = MM_RetentionReport::getAffiliateCookie(MM_OPTION_TERMS_AFFILIATE);
					$subAffiliateId = MM_RetentionReport::getAffiliateCookie(MM_OPTION_TERMS_SUB_AFFILIATE);
					
					if(isset($post["mm_affiliate_id_add"])){
						$affiliateId = $post["mm_affiliate_id_add"];
					}
					
					if(isset($post["mm_sub_affiliate_id_add"])){
						$subAffiliateId = $post["mm_sub_affiliate_id_add"];
					}
					
					LogMe::write("Tengine:affiliate data : ".$affiliateId." : ".$subAffiliateId);
					
					if($userId>0){
						if(!isset($post["mm_order_payment_choice"])){
							$post["mm_order_payment_choice"] = 0;
						}
		
						$paymentEngine = new MM_PaymentEngine($post["mm_order_payment_choice"]);
						$response = $paymentEngine->placeOrder($order);
						
						//$response = MM_LimeLightService::placeOrder($order);
						if(!isset($response->orderID) && $response instanceof MM_Response){
							return $response;
						}
						
						$customer->doUpdateLL = false;
						if($isMemberTypeOrder){
							$customer->setMainOrderId($response->orderID);
							$customer->setCustomerId($response->customerId);
							$customer->setLastOrder("");
							$customer->commitData();
							
							$retentionReport = new MM_RetentionReport();
							$retentionReport->setAffiliateId($affiliateId);
							$retentionReport->setSubAffiliateId($subAffiliateId);
							$retentionReport->setOrderId($response->orderID);
							$retentionReport->setUserId($customer->getId());
							$retentionReport->setProductId($product->getId());
							$retentionReport->setRefId($memberType->getId());
							$retentionReport->setRefType(MM_TYPE_MEMBER_TYPE);
							$retentionReport->commitData();
							
							return new MM_Response();
						}
						else{
							
							$tag = $product->getAssociatedAccessTag();
							if(isset($tag->id) && intval($tag->id)>0){
								$retentionReport = new MM_RetentionReport();
								$retentionReport->setAffiliateId($affiliateId);
								$retentionReport->setSubAffiliateId($subAffiliateId);
								$retentionReport->setOrderId($response->orderID);
								$retentionReport->setUserId($customer->getId());
								$retentionReport->setProductId($product->getId());
								$retentionReport->setRefId($tag->id);
								$retentionReport->setRefType(MM_TYPE_ACCESS_TAG);
								$retentionReport->commitData();
							}
						}
						$customer->commitData();
						return $response;
					}
					else{
		
						if(!isset($post["mm_order_payment_choice"])){
							$post["mm_order_payment_choice"] = 0;
						}
						$order->setPaymentOption($post["mm_order_payment_choice"]);
						$response = $order->commitData();
					
						$userId = $order->getCustomer()->getId();
						if(isset($response->message["url"]) || isset($response->message->url)){
		
							$retentionReport = new MM_RetentionReport();
							$retentionReport->setAffiliateId($affiliateId);
							$retentionReport->setSubAffiliateId($subAffiliateId);
							$retentionReport->setProductId($memberType->getRegistrationProduct());
							$retentionReport->setOrderId("");
							$retentionReport->setUserId($userId);
							$retentionReport->setRefId($memberType->getId());
							$retentionReport->setRefType(MM_TYPE_MEMBER_TYPE);
							$retentionReport->setPaymentMethodId($post["mm_order_payment_choice"]);
							$retentionReport->commitData();
							return $response;
						}
						
						if($response->type == MM_Response::$SUCCESS)
						{
		
							$orderId =  MM_Session::value(MM_Session::$KEY_LAST_ORDER_ID);
							
							$orderHistory = new MM_OrderHistory();
							$orderHistory->setId($orderId);
							$orderHistory->setOrderDate(Date("Y-m-d h:i:s"));
							$orderHistory->setProductId($memberType->getRegistrationProduct()); //reference to local product
							$orderHistory->setUserId($userId);
							$orderHistory->commitData();
							
							$retentionReport = new MM_RetentionReport();
							$retentionReport->setAffiliateId($affiliateId);
							$retentionReport->setSubAffiliateId($subAffiliateId);
							$retentionReport->setProductId($memberType->getRegistrationProduct());
							$retentionReport->setOrderId($orderId);
							$retentionReport->setUserId($userId);
							$retentionReport->setRefId($memberType->getId());
							$retentionReport->setRefType(MM_TYPE_MEMBER_TYPE);
							$retentionReport->commitData();
							
		        			MM_Session::value(MM_Session::$KEY_LAST_USER_ID, $order->getCustomer()->getId());
				 			$memberType->sendWelcomeEmail($order->getCustomer()->getId());
							
							foreach($post as $k=>$v){
								if(preg_match("/(mm_custom_)/", $k)){
									$id = preg_replace("/[^0-9]+/", "", $k);
									$order->getCustomer()->setCustomData(intval($id), $post[$k]);
								}
							}	
						}
					}
					return $response;
				}
				else 
				{
		
					$customer->setCustomerId(self::$MM_DFLT_CUSTOMER_ID);
					$customer->setMainOrderId(self::$MM_DFLT_ORDER_ID);
					
					$response = $customer->commitData();
					
					foreach($post as $k=>$v){
						if(preg_match("/(mm_custom_)/", $k)){
							$id = preg_replace("/[^0-9]+/", "", $k);
							$customer->setCustomData(intval($id), $post[$k]);
						}
					}
					
		
 					if($response->type == MM_Response::$SUCCESS)
					{
						$affiliateId = MM_RetentionReport::getAffiliateCookie(MM_OPTION_TERMS_AFFILIATE);
						$subAffiliateId = MM_RetentionReport::getAffiliateCookie(MM_OPTION_TERMS_SUB_AFFILIATE);
					
					if(isset($post["mm_affiliate_id_add"])){
						$affiliateId = $post["mm_affiliate_id_add"];
					}
					
					if(isset($post["mm_sub_affiliate_id_add"])){
						$subAffiliateId = $post["mm_sub_affiliate_id_add"];
					}
		
						$retentionReport = new MM_RetentionReport();
						$retentionReport->setAffiliateId($affiliateId);
						$retentionReport->setSubAffiliateId($subAffiliateId);
						$retentionReport->setProductId($memberType->getRegistrationProduct());
						$retentionReport->setOrderId(self::$MM_DFLT_ORDER_ID);
						$retentionReport->setUserId($customer->getId());
						$retentionReport->setRefId($memberType->getId());
						$retentionReport->setRefType(MM_TYPE_MEMBER_TYPE);
						$retentionReport->commitData();
						 
        				MM_Session::value(MM_Session::$KEY_LAST_USER_ID, $customer->getId());
		 				$memberType->sendWelcomeEmail($customer->getId());
					}
		
					return $response;
				}
			}
			else {
		
				return new MM_Response("Unable to place order. Member type id '".$customer->getMemberTypeId()."' is invalid.", MM_Response::$ERROR);
			}
		}
		else {
		
			return $memberExists;
		}
	}
}
