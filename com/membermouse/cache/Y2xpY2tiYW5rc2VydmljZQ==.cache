/**
 * 
 * 
MemberMouse(TM) (http://www.membermouse.com)
(c) 2010-2011 Pop Fizz Studios, LLC. All rights reserved.
 */
class MM_ClickBankService extends MM_PaymentService{
	public static $PAYMENT_STATUS_SALE = "SALE";
	public static $PAYMENT_STATUS_TEST_SALE = "TEST_SALE";
	public static $PAYMENT_STATUS_REFUND = "RFND";
	public static $PAYMENT_STATUS_CHARGEBACK = "CGBK";
	public static $PAYMENT_STATUS_ECHECK_CHARGEBACK = "INSF";
	public static $PAYMENT_STATUS_CANCEL_REBILL = "CANCEL-REBILL";
	public static $PAYMENT_STATUS_UNCANCEL_REBILL = "UNCANCEL-REBILL";
	public static $PAYMENT_STATUS_TEST = "TEST";
	
	public function __construct(){
			
	}
	
	public function fastForwardMembership(MM_Product $product, $price, $days=0){
		global $current_user;
		
		$user = new MM_User($current_user->ID);
		$paymentId = MM_PaymentService::getDefaultPaymentMethodId("clickbank");
		$product->setPrice($price);
		return $this->purchaseProduct($user, $product,false,$paymentId, 0, true);
		
	}

	public function refundOrder($id, $refundAmount){
		return new MM_Response("Could not find order with ClickBank", MM_Response::$ERROR);	
	}
	
	public function viewOrder($id){
		return new MM_Response("Could not find order with ClickBank", MM_Response::$ERROR);	
	}
	
	public function restRequest($api, $method, $post=""){
		$ch = curl_init();
		$url = "https://api.clickbank.com/rest/1.2/{$api}/{$method}";
		curl_setopt($ch, CURLOPT_URL, $url."?".$post);
		curl_setopt($ch, CURLOPT_HEADER, true);
//		curl_setopt($ch, CURLOPT_POST, 1);
//		curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_HTTPHEADER, array("Accept: application/json", "Authorization: DEV-F4A53622A359E73C3A8BE2BA3B136DE378AF:API-6045E75DFA2632F8AE3171C51143F3DF9ADE"));
		$result = curl_exec($ch);
		curl_close($ch);
		
		return $result;
	}
	
	public function purchaseProduct(MM_User $user, $productId, $initializeNewSubscription=false, $paymentOptionId=0, $shippingOptionId=0, $isFastForward=false){
		$campaignOptions = new MM_CampaignOptions($paymentOptionId);
		$jsonStr = $campaignOptions->getAttr();
		$obj  = json_decode($jsonStr);
		$vendor = (isset($obj->vendor))?$obj->vendor:"VENDOR";
		$product=  new MM_Product();
		if($productId instanceof MM_Product){
			$product = $productId;
		}
		else{
			$product = new MM_Product($productId);
		}
		$url   =   "http://".$product->getProductId().".".$vendor.".pay.clickbank.net";
		
		$params = array(
			'is_standard'=>1,
		);
		return self::getRequest($url, $params);
	}
	
	public function changeMembership(MM_User $user, MM_MemberType $crntMemberType, MM_MemberType $newMemberType){
		return $this->purchaseProduct($user, $newMemberType->getRegistrationProduct(), false, MM_CampaignOptions::getOptionRow(get_class(new MM_ClickBankService())),0);
		
	}
	
	public function updateOrderRecurring($orderId, $status, $userId=0){
		global $current_user;
		if($status == MM_MemberStatus::$CANCELED || $status==MM_MemberStatus::$PAUSED || $status==MM_MemberStatus::$LOCKED){
			$userId = ($userId<=0)?$current_user->ID:$userId;
			
			$user = new MM_User($userId);
			if($user->isValid()){
				$memberType = new MM_MemberType($user->getMemberTypeId());
				if(!$memberType->isFree()){
					$productId = $memberType->getRegistrationProduct();
					$callbackService = new MM_CallbackResponse();
					$callbackService->setUserId($userId);
					$callbackService->setProductId($productId);
					$callbackService->getDataByUserAndProduct();
					
					if($callbackService->isValid()){
						LogMe::write("ClicBankService::ctransaction request : ".__LINE__);
						$response = $callbackService->getResponse();
						
						if(isset($response->ctransreceipt)){
							LogMe::write("RECEIPT TO USE : ".$response->ctransreceipt);
							$content = $this->restRequest("tickets",$response->ctransreceipt, "type=cncl&reason=ticket.type.refund.1&comment=from+membermouse");
							$user->setStatus($status);
							LogMe::write("ClicBankService::cancellation response : ".json_encode($content));
						}
						LogMe::write("ClicBankService::cancellation response : ".json_encode($response));
					}
				}
			}
			else{
				$user->setStatus($status);
			}
			$user->commitData();
			return new MM_Response(MM_OptionUtils::getOption("home"));
		}
		return new MM_Response("updateOrderRecurring function not implemented for Clickbank", MM_Response::$ERROR);
	}
	
	protected function saveMember($post){
		/*
		 *  {\"cprodtitle\":\"MM Test\",\"ctranspaymentmethod\":\"CARD\",\"cfuturepayments\":\"\",\"ccustzip\":\"29579\",
		 *  \"ccustshippingzip\":\"29579\",\"ccustemail\":\"matt@somesite.com\",\"crebillstatus\":\"\",\"ctransaffiliate\":\"\",
		 *  \"cupsellreceipt\":\"\",\"corderamount\":\"300\",\"ccustcounty\":\"\",\"ccurrency\":\"USD\",\"ccustfirstname\":\"MATT\",
		 *  \"crebillamnt\":\"\",\"ctransaction\":\"TEST_SALE\",\"ccuststate\":\"SC\",\"caccountamount\":\"178\",
		 *  \"ctranspublisher\":\"dating1280\",\"ctid\":\"\",\"ccustshippingcountry\":\"US\",\"cnextpaymentdate\":\"\",\"cverify\":\"971523B2\",
		 *  \"cprocessedpayments\":\"\",\"cprodtype\":\"STANDARD\",\"ccustcc\":\"US\",\"ccustshippingstate\":\"SC\",
		 *  \"ctransreceipt\":\"WJYWBT3E\",\"ccustfullname\":\"Matt Young\",\"cvendthru\":\"url=http%3A%2F%2F1.dating1280.pay.clickbank.net&\",
		 *  \"ctransrole\":\"VENDOR\",\"ccustaddr2\":\"\",\"ccustaddr1\":\"\",\"ccustcity\":\"\",\"ccustlastname\":\"YOUNG\",
		 *  \"ctranstime\":\"1300648166\",\"cproditem\":\"1\"}"
		 */
		
		$customerFields = new stdClass();
		$customerFields->email = $post["ccustemail"];
		$customerFields->product_id = $post["cproditem"];
		$customerFields->first_name = $post["ccustfirstname"];
		$customerFields->last_name = $post["ccustlastname"];
		$customerFields->billing_country = "";
		$customerFields->billing_address = "";
		$customerFields->billing_city = "";
		$customerFields->billing_state = "";
		$customerFields->billing_zip = "";
		$customerFields->shipping_country = $post["ccustcc"];
		$customerFields->shipping_address = $post["ccustaddr1"];
		$customerFields->shipping_city = $post["ccustcity"];
		$customerFields->shipping_state = $post["ccustshippingstate"];
		$customerFields->shipping_zip = $post["ccustzip"];
		$customerFields->order_id = "";
		$customerFields->payment_id = $this->getPaymentId($post["ctranspublisher"]);
		
		return $this->createMember($customerFields);
	}
	
	private function getPaymentId($vendor){
		$options = MM_CampaignOptions::getOptions("payment");
		foreach($options as $id=>$val){
			$obj = new MM_CampaignOptions($id);
			if($obj->isValid()){
				$attr = $obj->getAttr();
				$json = json_decode($attr);
				if(isset($json->vendor)){
					if($json->vendor == $vendor){
						return $obj->getId();
					}
				}
			}
		}
		return 0;
	}
	
	public function handleCallback($request){
		if(!isset($request["ccustemail"])){
			return false;
		}
		
		$user = new MM_User();
		$user->setEmail($request["ccustemail"]);
		$user->getDataByEmail();
		
		$newMember = false;
		if(!$user->isValid()){
			$user = $this->saveMember($request);
			if($user===false){
				return $user;
			}
			$newMember = true;
		}
		else{
			LogMe::write("ClicBankService::$HandleResponse  ".__LINE__);
			$response = $this->updateMemberProducts($user->getId(), $request["cproditem"]);
			if($response->type == MM_Response::$ERROR){
				LogMe::write("ClicBankService::HandleResponse ERROR ".__LINE__." : ".$response->message);
				return $response;
			}
			$user = new MM_User($user->getId());
			LogMe::write("PayPalClicBankServiceService::HandleResponse  ".__LINE__." : json : ".json_encode($response));
		}
		
		try{
			$productId = $request["cproditem"];
			$callbackResponse = new MM_CallbackResponse();
			$callbackResponse->setResponse($request);
			$callbackResponse->setProductId($productId);
			$callbackResponse->setUserId($user->getId());
			$callbackResponse->getDataByUserAndProduct();
			
			MM_Session::value(MM_Session::$KEY_LAST_USER_ID,$user->getId());
			
			$paymentObj = MM_Utils::getPaymentMethodObj($this);
			$paymentId = (isset($paymentObj->id))?$paymentObj->id:0;
			$callbackResponse->setPaymentId($paymentId);
			
			$callbackResponse->setPaymentMethod(get_class($this));
				
			if(isset($request["ctransaction"])){
				LogMe::write("ClicBankService::ctransaction request : ".json_encode($request));
				$callbackResponse->setPaymentStatus($request["ctransaction"]);
				$requestObj = MM_Utils::convertArrayToObject($request);
				$shouldRefund ="0";
				echo $request["ctransaction"];
				$product = new MM_Product($productId);
				switch($request["ctransaction"]){
					case self::$PAYMENT_STATUS_TEST:
					case self::$PAYMENT_STATUS_SALE:
					case self::$PAYMENT_STATUS_TEST_SALE:
					case self::$PAYMENT_STATUS_UNCANCEL_REBILL:
				LogMe::write("ClicBankService::ctransaction request : ".__LINE__);
						$crntMemberType = new MM_MemberType($user->getMemberTypeId());
				LogMe::write("ClicBankService::ctransaction request : {member type} ".$user->getMemberTypeId()." :  {PRODUCT} {$productId} :".__LINE__);
						if($product->isAssociatedWithMemberType() && !$newMember){
				LogMe::write("ClicBankService::ctransaction request : ".__LINE__);
							$callbackService = new MM_CallbackResponse();
							$callbackService->setUserId($user->getId());
							$callbackService->setProductId($productId);
							$callbackService->getDataByUserAndProduct();
							
							if($callbackService->isValid()){
								LogMe::write("ClicBankService::ctransaction request : ".__LINE__);
								$response = $callbackService->getResponse();
								
								if(isset($response->ctransreceipt)){
									LogMe::write("RECEIPT TO USE : ".$response->ctransreceipt);
									$content = $this->restRequest("tickets",$response->ctransreceipt, "type=cncl&reason=ticket.type.refund.1&comment=from+membermouse");
									LogMe::write("ClicBankService::cancellation response : ".json_encode($content));
								}
								LogMe::write("ClicBankService::cancellation response : ".json_encode($response));
							}
						}
								
						if($newMember){
							$this->addRetentionRecord("",$user->getId(),$request["cproditem"], $user->getMemberTypeId(), MM_TYPE_MEMBER_TYPE, $this->getPaymentId($request["ctranspublisher"]));
						}
						$user->setStatus(MM_MemberStatus::$ACTIVE);
						break;
					case self::$PAYMENT_STATUS_REFUND:
						$shouldRefund = "1";
					case self::$PAYMENT_STATUS_CHARGEBACK:
					case self::$PAYMENT_STATUS_ECHECK_CHARGEBACK:
					case self::$PAYMENT_STATUS_CANCEL_REBILL:
						
						if($product->isAssociatedWithMemberType()){
							$row = $product->getAssociatedMemberType();
							if(isset($row->id)){
								if($user->getMemberTypeId() == $row->id){
									$this->cancel($user->getId());
								}
							}
						}
						else if($product->isAssociatedWithAccessTag()){
							
							$row= $product->getAssociatedAccessTag();
							
							if(isset($row->id)){
								$applied = new MM_AppliedAccessTag();
								$applied->setAccessTagId($row->id);
								$applied->setRefId($user->getId());
								$applied->getDataByTagAndUser();
								$applied->setStatus("0");
								$applied->setIsRefunded($shouldRefund);
								$applied->commitData();	
							}
						}
						break;
				}
				$user->doUpdateLL = false;
				$user->commitData();
			}
			$callbackResponse->commitData();
		}
		catch(Exception $e){
		}
		return true;
	}
	
	public function placeOrder(MM_Order $order){
		$campaignOptions = new MM_CampaignOptions($order->getPaymentOption());
		$jsonStr = $campaignOptions->getAttr();
		$obj  = json_decode($jsonStr);
		$vendor = (isset($obj->vendor))?$obj->vendor:"VENDOR";
		
		$memberTypeId = $order->getCustomer()->getMemberTypeId();
		$memberType = new MM_MemberType($memberTypeId);
		$product = new MM_Product($memberType->getRegistrationProduct());
		$url   =   "http://".$product->getProductId().".".$vendor.".pay.clickbank.net";
		
		$params = array();
		return self::getRequest($url, $params);
	}
	
	private static function getFrequencyType($freq){
		switch($freq){
			case "days":
				return "D";
			case "weeks":
				return "W";
			case "years":
				return "Y";
		}
		return "M";
	}
	
	public function placeOrderCardOnFile($previousOrderId, $campaignId, $productId, $shippingId, $userId, $priceOverride="", $initializeNewSubscription=false, $additionalParams=null){
		
	}
}